@implements IMenuParent
@inject IJSRuntime JSRuntime;

<div class="menubar" @onclick:preventDefault @onclick:stopPropagation="true" @onclick="()=>{}" @ref="ElementBox">
	@{
		int i = 0;
		FlatMenuItems = MenuItemProviderBasic.GetFlatMenuItems(ChildMenus).ToArray();
		foreach (var item in FlatMenuItems)
		{
			i++;
			switch (item)
			{
				case IMenuItemSingleBasic basic:
					<div tabindex="0" class="menubar_menu_button @(item.IsVisible?.Invoke() == false ? "hidden":"")" @onclick="async ()=>{await ItemClicked(basic);}" @ref="@basic.ElementHeader" @onmouseover="async ()=>{await MouseOverItem(basic);}" @onkeydown="async e =>await KeyDown(e,basic)">@basic.Title</div>
					break;
			}
		}
	}
</div>

<CascadingValue Name="Parent" Value="this">
	@ChildContent
</CascadingValue>

@code {
	IMenuItemSingle[]? FlatMenuItems;

	[Parameter]
	public RenderFragment? ChildContent { get; set; }

	[CascadingParameter(Name = nameof(Root))]
	public FullEditor? Root { get; set; }

	public ElementReference? ElementBox { get; set; }

	public int ZIndex => 256;

	System.Collections.ObjectModel.ObservableCollection<IMenuItem> ChildMenus { get; } = new();

	public void AddItem(IMenuItem menuItem)
	{
		ChildMenus.Add(menuItem);
		StateHasChanged();
	}

	public void Hide()
	{
		if (FlatMenuItems is null) return;
		foreach (var item in FlatMenuItems)
		{
			item.Hide();
		}
		StateHasChanged();
	}

	public MenuPosition ChildPosition => MenuPosition.Bottom;

	public async Task ItemClicked(IMenuItemSingleBasic item)
	{
		if (item.HasChild && item.IsChildrenVisible)
		{
			Hide();
			StateHasChanged();
			return;
		}
		Root?.HideMenuBar();
		Hide();
		await item.InvokeAsync();
		if (Root is not null) Root.CurrentMenu = this;
		StateHasChanged();
		return;
	}

	public async Task MouseOverItem(IMenuItemSingleBasic item)
	{
		if (!ChildMenus.Any(a => (a as IMenuItemSingle)?.IsChildrenVisible == true)) return;
		if (item.IsChildrenVisible) return;
		if (!item.HasChild) return;
		Hide();
		await item.ShowAsync();
		StateHasChanged();
	}

	async Task KeyDown(KeyboardEventArgs keyboard, IMenuItemSingleBasic basic)
	{
		//Console.WriteLine(keyboard.Key);
		if (keyboard.Key == "Enter")
		{
			await ItemClicked(basic);
		}
	}

	public void NotifyStateHasChanged() => StateHasChanged();
}
