<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>AozoraEditor</title>
    <base href="/" />
    <link href="css/app.css" rel="stylesheet" />
    <link href="manifest.json" rel="manifest" />

    <!-- If you add any scoped CSS files, uncomment the following to load them
    <link href="AozoraEditor.styles.css" rel="stylesheet" /> -->
</head>

<body>
    <div id="app">Loading...</div>

    <script src="./lib/monaco-editor/min/vs/loader.js"></script>

    <script>
        require.config({ paths: { vs: "./lib/monaco-editor/min/vs" } });

        const snippets = [
            { key: 'kaicho', text: 'æ”¹ä¸' },
            { key: 'kaipage', text: 'æ”¹ãƒšãƒ¼ã‚¸' },
            { key: 'kaimihiraki', text: 'æ”¹è¦‹é–‹ã' },
            { key: 'kaidan', text: 'æ”¹æ®µ' },

            { key: 'jisa', text: '${1:number}å­—ä¸‹ã’' },
            { key: 'jisastart', text: ['ã“ã“ã‹ã‚‰${1:number}å­—ä¸‹ã’', 'ã“ã“ã§å­—ä¸‹ã’çµ‚ã‚ã‚Š'].join('\n') },
            { key: 'jisaorikaeshi', text: ['ã“ã“ã‹ã‚‰${1:number}å­—ä¸‹ã’ã€æŠ˜ã‚Šè¿”ã—ã¦${2:number}å­—ä¸‹ã’', 'ã“ã“ã§å­—ä¸‹ã’çµ‚ã‚ã‚Š'].join('\n') },
            { key: 'tenorikaeshi', text: 'ã“ã“ã‹ã‚‰æ”¹è¡Œå¤©ä»˜ãã€æŠ˜ã‚Šè¿”ã—ã¦[ï¼-ï¼™]+å­—ä¸‹ã’' },

        ];

        //ã‚¨ãƒ‡ã‚£ã‚¿ã¯é…åˆ—ã§ç›£ç†ã—ã¦ã€è¦ç´ ã®ç•ªå·ã‚’IDã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚
        var editors = [];

        function GetMonacoText(editor_id) {
            if (editor_id < 0 || editor_id >= editors.length) return "";
            return editors[editor_id].getValue();
        }

        function ApplyMonacoEditorAozora(container_id, initial_text) {//id:string
            const editor_id = editors.length;
            require(["vs/editor/editor.main"], function () {
                monaco.languages.register({ id: 'aozora' });
                const keywords = [];//ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯åŸºæœ¬ï¼»ï¼ƒ.+?ï¼½ã®ä¸­ãªã®ã§ã€åˆ¥ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã™ã‚‹å¿…è¦ã¯ãªã„ã¨åˆ¤æ–­
                monaco.languages.setMonarchTokensProvider('aozora', {
                    defaultToken: 'invalid',
                    keywords,
                    tokenizer: {
                        root: [
                            [/ã€Š.*?ã€‹/, 'ruby'],
                            [/â€»?ï¼»ï¼ƒ.+?ï¼½/, 'command'],
                            [/ã€”.+?ã€•/, 'accent'],
                            [/^åº•æœ¬ï¼š.+$/, 'sokohon'],
                        ],
                    }
                });

                monaco.editor.defineTheme('aozoraThemeLight', {
                    base: 'vs',
                    inherit: false,
                    rules: [
                        { token: 'ruby', foreground: '808080' },
                        { token: 'command', foreground: '00A000', fontStyle: 'bold' },
                        { token: 'accent', foreground: '0000A0' },
                        { token: 'sokohon', foreground: '008000', },
                    ],
                    colors: {
                        'editor.foreground': '#000000'
                    }
                });

                monaco.editor.defineTheme('aozoraThemeDark', {
                    base: 'vs',
                    inherit: false,
                    rules: [
                        { token: 'ruby', foreground: '808080' },
                        { token: 'command', foreground: '006000', fontStyle: 'bold' },
                        { token: 'accent', foreground: '000060' },
                        { token: 'sokohon', foreground: '008800', },
                    ],
                    colors: {
                        'editor.foreground': '#FFFFFF'
                    }
                });

                monaco.languages.registerCompletionItemProvider('aozora', {
                    provideCompletionItems: (model, position, context, token) => {
                        //ã‚µã‚¸ã‚§ã‚¹ãƒˆæ©Ÿèƒ½ã¯è¡Œé ­ã‹ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥åŠ›å¾Œã—ã‹æ©Ÿèƒ½ã—ãªã„ã€‚å¾“ã£ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹ã€‚åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ä»¥å¤–ãªã‚‰å‰Šé™¤ä¸è¦ã€‚
                        let snipetDeleteSpace = [];
                        if (position.column > 2) { // columnã¯ãªãœã‹1ã‹ã‚‰å§‹ã¾ã‚‹ã€‚ã¾ãŸæ–‡å­—å…¥åŠ›å¾Œãªã®ã§ã€2ãªã‚‰è¡Œé ­ã€‚
                            let rangeEdit = { startLineNumber: position.lineNumber, endLineNumber: position.lineNumber, startColumn: position.column - 2, endColumn: position.column - 1 };
                            let charEdit = model.getValueInRange(rangeEdit);
                            if (charEdit == ' ') { snipetDeleteSpace = [{ text: '', range: rangeEdit }]; }
                        }
                        var suggestions = [
                            {
                                label: 'ruby',
                                kind: monaco.languages.CompletionItemKind.Snippet,
                                insertText: 'ã€Š${1:ruby}ã€‹',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                additionalTextEdits: snipetDeleteSpace,
                            },
                        ];
                        return { suggestions: suggestions };
                    }
                });

                //monaco.languages.registerDocumentFormattingEditProvider('aozora', {
                //    async provideDocumentFormattingEdits(model) {
                //        const text = model.getValue();
                //        return [
                //            {
                //                range: model.getFullModelRange(),
                //                text
                //            }
                //        ]
                //    }
                //});

                const editor = monaco.editor.create(
                    document.getElementById(container_id),
                    {
                        value: initial_text,
                        language: "aozora",
                        theme: 'aozoraThemeLight',

                        unicodeHighlight: {
                            ambiguousCharacters: false,
                        },

                        folding: true,
                        wordWrap: true,
                        automaticLayout: true,

                        suggest: {
                            snippetsPreventQuickSuggestions: false
                        }

                        // Disable suggestion:
                        //https://github.com/microsoft/monaco-editor/issues/1681
                        //suggest: {
                        //    showFields: false,
                        //    showFunctions: false,
                        //},
                        //quickSuggestions: {
                        //    "other": false,
                        //    "comments": false,
                        //    "strings": false
                        //},
                        //parameterHints: {
                        //    enabled: false
                        //},
                        //suggestOnTriggerCharacters: false,
                        //acceptSuggestionOnEnter: "off",
                        //tabCompletion: "off",
                        //wordBasedSuggestions: false,
                    }
                );
                editors[editor_id] = editor;
            });
            return editor_id;
        }
    </script>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ğŸ—™</a>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>
    <script>navigator.serviceWorker.register('service-worker.js');</script>
</body>

</html>
