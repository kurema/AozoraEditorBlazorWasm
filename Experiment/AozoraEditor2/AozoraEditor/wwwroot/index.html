<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>AozoraEditor</title>
    <base href="/" />
    <link href="css/app.css" rel="stylesheet" />
    <link href="manifest.json" rel="manifest" />

    <!-- If you add any scoped CSS files, uncomment the following to load them
    <link href="AozoraEditor.styles.css" rel="stylesheet" /> -->
</head>

<body>
    <div id="app">Loading...</div>

    <script src="./lib/monaco-editor/min/vs/loader.js"></script>

    <script>
        require.config({ paths: { vs: "./lib/monaco-editor/min/vs" } });

        const snippets = [
            { key: 'kaicho', text: '改丁' },
            { key: 'kaipage', text: '改ページ' },
            { key: 'kaimihiraki', text: '改見開き' },
            { key: 'kaidan', text: '改段' },

            { key: 'jisa', text: '${1:number}字下げ' },
            { key: 'jisastart', text: ['ここから${1:number}字下げ', 'ここで字下げ終わり'].join('\n') },
            { key: 'jisaorikaeshi', text: ['ここから${1:number}字下げ、折り返して${2:number}字下げ', 'ここで字下げ終わり'].join('\n') },
            { key: 'tenorikaeshi', text: 'ここから改行天付き、折り返して[０-９]+字下げ' },

        ];

        //エディタは配列で監理して、要素の番号をIDとして扱います。
        var editors = [];

        function GetMonacoText(editor_id) {
            if (editor_id < 0 || editor_id >= editors.length) return "";
            return editors[editor_id].getValue();
        }

        function ApplyMonacoEditorAozora(container_id, initial_text) {//id:string
            const editor_id = editors.length;
            require(["vs/editor/editor.main"], function () {
                monaco.languages.register({ id: 'aozora' });
                const keywords = [];//キーワードは基本［＃.+?］の中なので、別にハイライトをする必要はないと判断
                monaco.languages.setMonarchTokensProvider('aozora', {
                    defaultToken: 'invalid',
                    keywords,
                    tokenizer: {
                        root: [
                            [/《.*?》/, 'ruby'],
                            [/※?［＃.+?］/, 'command'],
                            [/〔.+?〕/, 'accent'],
                            [/^底本：.+$/, 'sokohon'],
                        ],
                    }
                });

                monaco.editor.defineTheme('aozoraThemeLight', {
                    base: 'vs',
                    inherit: false,
                    rules: [
                        { token: 'ruby', foreground: '808080' },
                        { token: 'command', foreground: '00A000', fontStyle: 'bold' },
                        { token: 'accent', foreground: '0000A0' },
                        { token: 'sokohon', foreground: '008000', },
                    ],
                    colors: {
                        'editor.foreground': '#000000'
                    }
                });

                monaco.editor.defineTheme('aozoraThemeDark', {
                    base: 'vs',
                    inherit: false,
                    rules: [
                        { token: 'ruby', foreground: '808080' },
                        { token: 'command', foreground: '006000', fontStyle: 'bold' },
                        { token: 'accent', foreground: '000060' },
                        { token: 'sokohon', foreground: '008800', },
                    ],
                    colors: {
                        'editor.foreground': '#FFFFFF'
                    }
                });

                monaco.languages.registerCompletionItemProvider('aozora', {
                    provideCompletionItems: (model, position, context, token) => {
                        //サジェスト機能は行頭かスペースを入力後しか機能しない。従ってスペースを削除する。半角スペース以外なら削除不要。
                        let snipetDeleteSpace = [];
                        if (position.column > 2) { // columnはなぜか1から始まる。また文字入力後なので、2なら行頭。
                            let rangeEdit = { startLineNumber: position.lineNumber, endLineNumber: position.lineNumber, startColumn: position.column - 2, endColumn: position.column - 1 };
                            let charEdit = model.getValueInRange(rangeEdit);
                            if (charEdit == ' ') { snipetDeleteSpace = [{ text: '', range: rangeEdit }]; }
                        }
                        var suggestions = [
                            {
                                label: 'ruby',
                                kind: monaco.languages.CompletionItemKind.Snippet,
                                insertText: '《${1:ruby}》',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                additionalTextEdits: snipetDeleteSpace,
                            },
                        ];
                        return { suggestions: suggestions };
                    }
                });

                //monaco.languages.registerDocumentFormattingEditProvider('aozora', {
                //    async provideDocumentFormattingEdits(model) {
                //        const text = model.getValue();
                //        return [
                //            {
                //                range: model.getFullModelRange(),
                //                text
                //            }
                //        ]
                //    }
                //});

                const editor = monaco.editor.create(
                    document.getElementById(container_id),
                    {
                        value: initial_text,
                        language: "aozora",
                        theme: 'aozoraThemeLight',

                        unicodeHighlight: {
                            ambiguousCharacters: false,
                        },

                        folding: true,
                        wordWrap: true,
                        automaticLayout: true,

                        suggest: {
                            snippetsPreventQuickSuggestions: false
                        }

                        // Disable suggestion:
                        //https://github.com/microsoft/monaco-editor/issues/1681
                        //suggest: {
                        //    showFields: false,
                        //    showFunctions: false,
                        //},
                        //quickSuggestions: {
                        //    "other": false,
                        //    "comments": false,
                        //    "strings": false
                        //},
                        //parameterHints: {
                        //    enabled: false
                        //},
                        //suggestOnTriggerCharacters: false,
                        //acceptSuggestionOnEnter: "off",
                        //tabCompletion: "off",
                        //wordBasedSuggestions: false,
                    }
                );
                editors[editor_id] = editor;
            });
            return editor_id;
        }
    </script>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>
    <script>navigator.serviceWorker.register('service-worker.js');</script>
</body>

</html>
